<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房地產環景導覽平台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pannellum/2.5.6/pannellum.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pannellum/2.5.6/pannellum.css">
    <!-- 添加A-Frame支援WebXR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <!-- 添加three.js用於坐標轉換 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .vr-btn {
            background-color: #e74c3c;
        }
        
        .vr-btn:hover {
            background-color: #c0392b;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            position: relative;
        }
        
        #panorama {
            width: 100%;
            height: 100%;
        }
        
        .property-info {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 4px;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .property-info h2 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .property-info p {
            margin-bottom: 0.5rem;
            color: #34495e;
        }
        
        .room-selector {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0.5rem;
            border-radius: 4px;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .room-btn {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .room-btn:hover, .room-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .hotspot {
            cursor: pointer;
        }
        
        .info-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            z-index: 1000;
            display: none;
        }
        
        .info-popup h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .info-popup p {
            margin-bottom: 1rem;
            color: #34495e;
        }
        
        .info-popup img {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1001;
        }
        
        .loader::after {
            content: "";
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .editor-controls {
            position: absolute;
            top: 5rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .edit-mode {
            background-color: #f39c12;
        }
        
        .edit-mode:hover {
            background-color: #d35400;
        }
        
        .hotspot-form {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 300px;
            z-index: 1000;
            display: none;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        /* VR模式的A-Frame場景，默認隱藏 */
        #vr-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: none;
        }
        
        .exit-vr-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 2001;
            display: none;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">房地產環景導覽</div>
            <div class="controls">
                <button class="btn" id="fullscreen-btn">全螢幕</button>
                <button class="btn vr-btn" id="vr-btn">VR模式</button>
                <button class="btn edit-mode" id="edit-btn">編輯模式</button>
            </div>
        </header>
        
        <div class="main-content">
            <div id="panorama"></div>
            
            <div class="property-info">
                <h2>豪華示範住宅</h2>
                <p><strong>坪數:</strong> 40坪</p>
                <p><strong>格局:</strong> 4房2廳2衛</p>
                <p><strong>樓層:</strong> 1-4F/RF</p>
                <p><strong>地址:</strong> 維次宇宙</p>
            </div>
            
            <div class="room-selector">
                <button class="room-btn active" data-room="living">客廳</button>
                <button class="room-btn" data-room="kitchen">餐廳</button>
                <button class="room-btn" data-room="master">2F臥室</button>
                <button class="room-btn" data-room="bedroom">3F臥室</button>
                <button class="room-btn" data-room="bathroom">浴室</button>
                <button class="room-btn" data-room="balcony">陽台</button>
            </div>
            
            <div class="loader" id="loader"></div>
        </div>
        
        <div class="info-popup" id="info-popup">
            <button class="close-btn" id="close-popup">&times;</button>
            <h3 id="popup-title"></h3>
            <img id="popup-img" src="" alt="">
            <p id="popup-description"></p>
        </div>
        
        <div class="editor-controls" id="editor-controls" style="display: none;">
            <button class="btn" id="add-info-btn">添加資訊熱點</button>
            <button class="btn" id="add-scene-btn">添加場景熱點</button>
            <button class="btn" id="save-hotspots-btn">保存熱點</button>
            <button class="btn" id="delete-hotspot-btn" style="display: none;">刪除熱點</button>
        </div>
        
        <div class="hotspot-form" id="hotspot-form">
            <h3 id="form-title">添加熱點</h3>
            <div class="form-group">
                <label for="hotspot-type">熱點類型</label>
                <select id="hotspot-type">
                    <option value="info">資訊熱點</option>
                    <option value="scene">場景切換熱點</option>
                </select>
            </div>
            <div class="form-group">
                <label for="hotspot-text">顯示文字</label>
                <input type="text" id="hotspot-text" placeholder="輸入熱點顯示文字">
            </div>
            <div class="form-group" id="info-id-group">
                <label for="hotspot-id">熱點ID</label>
                <input type="text" id="hotspot-id" placeholder="輸入唯一ID">
            </div>
            <div class="form-group" id="scene-id-group" style="display: none;">
                <label for="scene-id">目標場景</label>
                <select id="scene-id">
                    <option value="living">客廳</option>
                    <option value="kitchen">餐廳</option>
                    <option value="master">2F臥室</option>
                    <option value="bedroom">3F臥室</option>
                    <option value="bathroom">浴室</option>
                    <option value="balcony">陽台</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn" id="cancel-hotspot-btn">取消</button>
                <button class="btn" id="confirm-hotspot-btn">確認</button>
            </div>
        </div>
    </div>
    
    <!-- VR模式的A-Frame場景 -->
    <button id="exit-vr-btn" class="exit-vr-btn">退出VR</button>
    <a-scene id="vr-scene" embedded vr-mode-ui="enabled: true" style="display: none;" cursor="rayOrigin: mouse" raycaster="objects: .vr-hotspot">
        <a-assets id="vr-assets">
            <img id="vr-panorama" crossorigin="anonymous">
        </a-assets>
        <a-sky id="vr-sky" rotation="0 -90 0"></a-sky>
        <!-- 添加控制器射線 -->
        <a-entity laser-controls="hand: right" raycaster="objects: .vr-hotspot;"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: .vr-hotspot;"></a-entity>
        <!-- 相機及游標 -->
        <a-camera position="0 1.6 0">
            <a-cursor raycaster="objects: .vr-hotspot"></a-cursor>
        </a-camera>
    </a-scene>
    
    <script>
        // 使用相對路徑的房間全景圖定義（移除預設熱點）
        const rooms = {
            living: {
                url: "1F客廳.jpg", 
                title: "寬敞客廳",
                hotSpots: []
            },
            kitchen: {
                url: "1F餐廳.jpg", 
                title: "餐廳",
                hotSpots: []
            },
            master: {
                url: "2F臥室.jpg", 
                title: "臥室",
                hotSpots: []
            },
            bedroom: {
                url: "3F臥室1.jpg", 
                title: "次臥",
                hotSpots: []
            },
            bathroom: {
                url: "2F浴室.jpg", 
                title: "浴室",
                hotSpots: []
            },
            balcony: {
                url: "RF陽台.jpg", 
                title: "陽台",
                hotSpots: []
            }
        };
        
        // 熱點信息（已清空）
        const hotspotInfo = {};
        
        // 初始化全景圖
        let viewer;
        let currentScene = 'living';
        
        function loadScene(sceneName) {
            const scene = rooms[sceneName];
            
            // 顯示加載圖標
            document.getElementById('loader').style.display = 'flex';
            
            // 如果已有viewer則銷毀
            if (viewer) {
                viewer.destroy();
            }
            
            // 創建新的viewer
            viewer = pannellum.viewer('panorama', {
                default: {
                    firstScene: sceneName
                },
                scenes: {
                    [sceneName]: {
                        title: scene.title,
                        hfov: 110,
                        pitch: 0,
                        yaw: 0,
                        type: "equirectangular",
                        panorama: scene.url,
                        hotSpots: scene.hotSpots,
                        hotSpotDebug: false,
                        autoLoad: true
                    }
                },
                autoLoad: true
            });
            
            // 更新當前場景
            currentScene = sceneName;
            
            // 更新房間選擇按鈕狀態
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (btn.dataset.room === sceneName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 監聽全景圖加載完成事件
            viewer.on('load', function() {
                // 隱藏加載圖標
                document.getElementById('loader').style.display = 'none';
            });
            
            // 監聽熱點點擊事件
            viewer.on('click', function(e) {
                if (e.target.classList.contains('hotspot')) {
                    // 如果在編輯模式下，不處理普通點擊
                    if (isEditMode) return;
                    
                    const hotspotId = e.target.id.split('-')[0];
                    
                    if (hotspotInfo[hotspotId]) {
                        // 顯示信息彈窗
                        showInfoPopup(hotspotId);
                    } else {
                        // 查找場景切換熱點
                        const scene = rooms[currentScene];
                        const hotspot = scene.hotSpots.find(h => h.type === 'scene' && h.text.includes(hotspotId));
                        
                        if (hotspot && hotspot.sceneId) {
                            loadScene(hotspot.sceneId);
                        }
                    }
                }
            });
        }
        
        // 顯示信息彈窗
        function showInfoPopup(hotspotId) {
            const info = hotspotInfo[hotspotId];
            const popup = document.getElementById('info-popup');
            
            document.getElementById('popup-title').textContent = info.title;
            document.getElementById('popup-img').src = info.img;
            document.getElementById('popup-img').alt = info.title;
            document.getElementById('popup-description').textContent = info.description;
            
            popup.style.display = 'block';
        }
        
        // 編輯模式變數
        let isEditMode = false;
        let currentHotspotData = null;
        let tempHotspot = null;
        
        // 啟用/禁用編輯模式
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editorControls = document.getElementById('editor-controls');
            const editBtn = document.getElementById('edit-btn');
            
            if (isEditMode) {
                editorControls.style.display = 'flex';
                editBtn.textContent = '退出編輯';
                editBtn.classList.add('active');
                
                // 禁用場景切換
                document.querySelectorAll('.room-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                // 添加點擊監聽器用於定位熱點
                document.getElementById('panorama').addEventListener('mousedown', handlePanoramaClick);
            } else {
                editorControls.style.display = 'none';
                document.getElementById('delete-hotspot-btn').style.display = 'none';
                editBtn.textContent = '編輯模式';
                editBtn.classList.remove('active');
                
                // 啟用場景切換
                document.querySelectorAll('.room-btn').forEach(btn => {
                    btn.disabled = false;
                });
                
                // 移除點擊監聽器
                document.getElementById('panorama').removeEventListener('mousedown', handlePanoramaClick);
                
                // 移除臨時熱點
                if (tempHotspot) {
                    viewer.removeHotSpot(tempHotspot);
                    tempHotspot = null;
                }
            }
        }
        
        // 處理全景圖點擊事件（編輯模式下）
        function handlePanoramaClick(event) {
            // 獲取點擊位置的座標
            const coords = viewer.mouseEventToCoords(event);
            const pitch = coords[0];
            const yaw = coords[1];
            
            console.log('Clicked at pitch: ' + pitch + ', yaw: ' + yaw);
            
            // 如果是選擇現有熱點，不創建新熱點
            if (event.target.classList.contains('hotspot')) {
                return;
            }
            
            // 刪除之前的臨時熱點
            if (tempHotspot) {
                viewer.removeHotSpot(tempHotspot);
            }
            
            // 創建臨時熱點ID
            tempHotspot = 'temp-hotspot';
            
            // 添加臨時熱點到當前位置
            viewer.addHotSpot({
                id: tempHotspot,
                pitch: pitch,
                yaw: yaw,
                type: 'info',
                text: '新熱點',
                cssClass: 'hotspot'
            });
            
            // 存儲當前熱點數據
            currentHotspotData = {
                pitch: pitch,
                yaw: yaw
            };
            
            // 顯示熱點表單
            document.getElementById('hotspot-form').style.display = 'block';
        }
        
        // 保存所有熱點
        function saveAllHotspots() {
            // 將當前場景的熱點保存到rooms對象中
            // 在真實應用中，這裡應該發送API請求將數據保存到服務器
            alert('熱點位置已保存！在實際應用中，這裡應該將數據保存到服務器。');
            console.log('Current hotspots:', rooms[currentScene].hotSpots);
            
            // 將數據轉為JSON格式，方便匯出
            const hotspotsJson = JSON.stringify(rooms[currentScene].hotSpots, null, 2);
            console.log(hotspotsJson);
        }
        
        // 添加新熱點
        function addNewHotspot() {
            if (!currentHotspotData) return;
            
            const type = document.getElementById('hotspot-type').value;
            const text = document.getElementById('hotspot-text').value;
            
            if (!text) {
                alert('請輸入熱點顯示文字');
                return;
            }
            
            let newHotspot = {
                pitch: currentHotspotData.pitch,
                yaw: currentHotspotData.yaw,
                type: type,
                text: text
            };
            
            if (type === 'info') {
                const id = document.getElementById('hotspot-id').value;
                if (!id) {
                    alert('請輸入熱點ID');
                    return;
                }
                newHotspot.id = id;
                
                // 檢查ID是否已存在
                const idExists = rooms[currentScene].hotSpots.some(h => h.id === id);
                if (idExists) {
                    alert('此ID已存在，請使用其他ID');
                    return;
                }
                
                // 如果是info類型，需要在hotspotInfo中添加對應信息
                if (!hotspotInfo[id]) {
                    hotspotInfo[id] = {
                        title: text,
                        img: rooms[currentScene].url,
                        description: "請在此處添加描述"
                    };
                }
            } else if (type === 'scene') {
                const sceneId = document.getElementById('scene-id').value;
                newHotspot.sceneId = sceneId;
            }
            
            // 刪除臨時熱點
            if (tempHotspot) {
                viewer.removeHotSpot(tempHotspot);
                tempHotspot = null;
            }
            
            // 添加到場景熱點列表
            rooms[currentScene].hotSpots.push(newHotspot);
            
            // 重新加載場景以顯示新熱點
            loadScene(currentScene);
            
            // 隱藏表單
            document.getElementById('hotspot-form').style.display = 'none';
            currentHotspotData = null;
        }
        
        // 刪除選定熱點
        function deleteSelectedHotspot() {
            if (!selectedHotspotId) return;
            
            // 從熱點列表中移除
            rooms[currentScene].hotSpots = rooms[currentScene].hotSpots.filter(h => {
                if (h.type === 'info') {
                    return h.id !== selectedHotspotId;
                } else {
                    // 對於場景熱點，使用text進行比對
                    return !h.text.includes(selectedHotspotId);
                }
            });
            
            // 重新加載場景
            loadScene(currentScene);
            
            // 隱藏刪除按鈕
            document.getElementById('delete-hotspot-btn').style.display = 'none';
            selectedHotspotId = null;
        }
        
        // 用於存儲當前選中的熱點ID
        let selectedHotspotId = null;
        
        // 在編輯模式下處理熱點點擊
        function handleHotspotClick(e) {
            if (!isEditMode) return;
            
            if (e.target.classList.contains('hotspot')) {
                e.preventDefault();
                e.stopPropagation();
                
                // 獲取熱點ID
                const hotspotId = e.target.id.split('-')[0];
                selectedHotspotId = hotspotId;
                
                // 顯示刪除按鈕
                const deleteBtn = document.getElementById('delete-hotspot-btn');
                deleteBtn.style.display = 'block';
                deleteBtn.textContent = `刪除熱點: ${hotspotId}`;
            }
        }

        // WebXR VR模式相關函數
        function enterVRMode() {
            loadVRScene(currentScene);
        }

        // 新增加載VR場景的函數
        function loadVRScene(sceneName) {
            const scene = rooms[sceneName];
            currentScene = sceneName; // 更新當前場景
            
            // 先設置場景為可見
            document.getElementById('vr-scene').style.display = 'block';
            document.getElementById('exit-vr-btn').style.display = 'block';
            
            // 設置全景圖片並確保刷新
            const panoramaImg = document.getElementById('vr-panorama');
            // 添加時間戳以避免緩存問題
            panoramaImg.src = scene.url + '?t=' + new Date().getTime();
            
            // 強制A-Frame場景使用圖片
            const sky = document.getElementById('vr-sky');
            sky.setAttribute('src', scene.url + '?t=' + new Date().getTime());
            
            console.log("VR場景載入:", scene.url);
            
            // 清除之前的熱點
            const vrScene = document.querySelector('a-scene');
            vrScene.querySelectorAll('.vr-hotspot').forEach(el => el.parentNode.removeChild(el));
            
            // 添加當前場景的熱點到VR場景
            if (scene.hotSpots && scene.hotSpots.length > 0) {
                scene.hotSpots.forEach(hotspot => {
                    // 將Pannellum坐標轉換為A-Frame坐標
                    // Pannellum使用pitch(上下,-90到90)和yaw(左右,-180到180)
                    // A-Frame使用球面坐標系
                    const phi = THREE.MathUtils.degToRad(90 - hotspot.pitch);
                    const theta = THREE.MathUtils.degToRad(hotspot.yaw);
                    
                    // 計算3D位置 (半徑10的球體)
                    const radius = 10;
                    const x = radius * Math.sin(phi) * Math.cos(theta);
                    const y = radius * Math.cos(phi);
                    const z = radius * Math.sin(phi) * Math.sin(theta);
                    
                    // 創建熱點元素
                    const hotspotEl = document.createElement('a-entity');
                    hotspotEl.classList.add('vr-hotspot');
                    
                    // 設置位置
                    hotspotEl.setAttribute('position', `${x} ${y} ${z}`);
                    
                    // 創建熱點外觀
                    let color = hotspot.type === 'info' ? '#3498db' : '#e74c3c';
                    hotspotEl.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
                    hotspotEl.setAttribute('material', `color: ${color}; shader: flat; opacity: 0.8`);
                    
                    // 添加動畫效果使熱點更明顯
                    hotspotEl.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true');
                    
                    // 添加文字標籤
                    const textEl = document.createElement('a-text');
                    textEl.setAttribute('value', hotspot.text);
                    textEl.setAttribute('align', 'center');
                    textEl.setAttribute('position', '0 0.5 0');
                    textEl.setAttribute('scale', '2 2 2');
                    textEl.setAttribute('color', 'white');
                    textEl.setAttribute('look-at', '[camera]');
                    hotspotEl.appendChild(textEl);
                    
                    // 添加點擊事件
                    hotspotEl.addEventListener('click', function() {
                        if (hotspot.type === 'scene' && hotspot.sceneId) {
                            // 不退出VR，直接切換場景
                            
                            // 顯示過渡效果
                            sky.setAttribute('animation', {
                                property: 'material.opacity',
                                from: 1,
                                to: 0,
                                dur: 300,
                                easing: 'easeOutQuad'
                            });
                            
                            // 等待淡出完成後加載新場景
                            setTimeout(() => {
                                loadVRScene(hotspot.sceneId);
                                // 淡入新場景
                                sky.setAttribute('animation', {
                                    property: 'material.opacity',
                                    from: 0,
                                    to: 1,
                                    dur: 300,
                                    easing: 'easeInQuad'
                                });
                            }, 300);
                        } else if (hotspot.type === 'info' && hotspot.id) {
                            // 對於信息熱點，我們需要在VR中顯示信息
                            // 創建一個VR內的信息面板
                            showVRInfoPanel(hotspot.id, x, y, z);
                        }
                    });
                    
                    // 將熱點添加到場景
                    vrScene.appendChild(hotspotEl);
                });
            }
            
            // 更新房間選擇按鈕狀態 (即使在VR模式下也保持同步)
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (btn.dataset.room === sceneName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 隱藏普通介面
            document.querySelector('.container').style.display = 'none';
            
            // 如果這是初次進入VR，嘗試進入VR模式
            if (!document.querySelector('a-scene').is('vr-mode')) {
                if (vrScene.hasLoaded) {
                    setTimeout(() => {
                        try {
                            vrScene.enterVR();
                        } catch (e) {
                            console.error("進入VR模式時發生錯誤:", e);
                            // 如果無法進入VR模式，仍然顯示360環景
                        }
                    }, 1000);
                } else {
                    vrScene.addEventListener('loaded', function() {
                        setTimeout(() => {
                            try {
                                vrScene.enterVR();
                            } catch (e) {
                                console.error("進入VR模式時發生錯誤:", e);
                                // 如果無法進入VR模式，仍然顯示360環景
                            }
                        }, 1000);
                    });
                }
            }
        }

        // 在VR中顯示信息面板
        function showVRInfoPanel(hotspotId, x, y, z) {
            const info = hotspotInfo[hotspotId];
            const vrScene = document.querySelector('a-scene');
            
            // 移除之前的信息面板
            const oldPanel = vrScene.querySelector('#vr-info-panel');
            if (oldPanel) {
                oldPanel.parentNode.removeChild(oldPanel);
            }
            
            // 創建信息面板容器
            const panel = document.createElement('a-entity');
            panel.id = 'vr-info-panel';
            panel.setAttribute('position', `${x} ${y} ${z}`);
            
            // 計算面向用戶的方向
            const camera = document.querySelector('a-camera') || document.querySelector('[camera]');
            panel.setAttribute('look-at', '[camera]');
            
            // 創建背景板
            const background = document.createElement('a-plane');
            background.setAttribute('width', 4);
            background.setAttribute('height', 2.5);
            background.setAttribute('color', '#fff');
            background.setAttribute('opacity', 0.9);
            background.setAttribute('position', '0 0 0.1');
            panel.appendChild(background);
            
            // 添加標題
            const title = document.createElement('a-text');
            title.setAttribute('value', info.title);
            title.setAttribute('align', 'center');
            title.setAttribute('width', 3.8);
            title.setAttribute('position', '0 1 0.2');
            title.setAttribute('color', '#333');
            title.setAttribute('font', 'kelsonsans');
            panel.appendChild(title);
            
            // 添加描述文字
            const description = document.createElement('a-text');
            description.setAttribute('value', info.description);
            description.setAttribute('align', 'left');
            description.setAttribute('width', 3.5);
            description.setAttribute('wrap-count', 35);
            description.setAttribute('position', '-1.75 0 0.2');
            description.setAttribute('color', '#333');
            description.setAttribute('font', 'kelsonsans');
            panel.appendChild(description);
            
            // 添加關閉按鈕
            const closeBtn = document.createElement('a-entity');
            closeBtn.setAttribute('position', '1.8 1 0.2');
            closeBtn.setAttribute('geometry', 'primitive: plane; width: 0.3; height: 0.3');
            closeBtn.setAttribute('material', 'color: #e74c3c');
            closeBtn.setAttribute('text', 'value: X; align: center; color: white; width: 3');
            closeBtn.classList.add('vr-hotspot');  // 確保可點擊
            closeBtn.addEventListener('click', function() {
                panel.parentNode.removeChild(panel);
            });
            panel.appendChild(closeBtn);
            
            // 添加面板到場景
            vrScene.appendChild(panel);
            
            // 添加進入動畫
            panel.setAttribute('animation', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '1 1 1',
                dur: 300,
                easing: 'easeOutQuad'
            });
        }

        function exitVRMode() {
            // 隱藏VR場景，顯示普通介面
            document.getElementById('vr-scene').style.display = 'none';
            document.getElementById('exit-vr-btn').style.display = 'none';
            document.querySelector('.container').style.display = 'flex';
            
            // 確保A-Frame場景退出VR
            const sceneEl = document.querySelector('a-scene');
            if (sceneEl.is && sceneEl.is('vr-mode')) {
                sceneEl.exitVR();
            }
        }
        
        // 在文檔加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加載初始場景
            loadScene('living');
            
            // 房間切換按鈕事件
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!isEditMode) {
                        loadScene(this.dataset.room);
                    }
                });
            });
            
            // 關閉彈窗按鈕事件
            document.getElementById('close-popup').addEventListener('click', function() {
                document.getElementById('info-popup').style.display = 'none';
            });
            
            // 全螢幕按鈕事件
            document.getElementById('fullscreen-btn').addEventListener('click', function() {
                if (viewer) {
                    viewer.toggleFullscreen();
                }
            });
            
            // VR按鈕事件 - 使用WebXR
            document.getElementById('vr-btn').addEventListener('click', function() {
                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-vr')
                        .then(function(supported) {
                            if (supported) {
                                enterVRMode();
                            } else {
                                // 即使不支持沉浸式VR，也嘗試使用A-Frame提供的VR體驗
                                console.log("設備不支持沉浸式VR，將使用A-Frame提供的VR體驗");
                                enterVRMode();
                            }
                        })
                        .catch(function(error) {
                            console.error('WebXR檢查錯誤:', error);
                            // 嘗試使用A-Frame直接進入
                            enterVRMode();
                        });
                } else if ('getVRDisplays' in navigator) {
                    // 舊版WebVR API (已棄用)
                    navigator.getVRDisplays()
                        .then(function(displays) {
                            if (displays.length > 0) {
                                enterVRMode();
                            } else {
                                // 即使沒有檢測到VR顯示，也嘗試使用A-Frame提供的VR體驗
                                enterVRMode();
                            }
                        })
                        .catch(function(error) {
                            console.log('舊版WebVR API錯誤，將使用A-Frame提供的VR體驗');
                            enterVRMode();
                        });
                } else {
                    // 無VR支援時，仍嘗試使用A-Frame
                    console.log('未檢測到VR支援，將使用A-Frame提供的VR體驗');
                    enterVRMode();
                }
            });
            
            // 退出VR按鈕事件
            document.getElementById('exit-vr-btn').addEventListener('click', exitVRMode);
            
            // 編輯模式按鈕事件
            document.getElementById('edit-btn').addEventListener('click', toggleEditMode);
            
            // 添加資訊熱點按鈕事件
            document.getElementById('add-info-btn').addEventListener('click', function() {
                document.getElementById('hotspot-type').value = 'info';
                document.getElementById('info-id-group').style.display = 'block';
                document.getElementById('scene-id-group').style.display = 'none';
                document.getElementById('form-title').textContent = '添加資訊熱點';
                document.getElementById('hotspot-form').style.display = 'block';
            });
            
            // 添加場景熱點按鈕事件
            document.getElementById('add-scene-btn').addEventListener('click', function() {
                document.getElementById('hotspot-type').value = 'scene';
                document.getElementById('info-id-group').style.display = 'none';
                document.getElementById('scene-id-group').style.display = 'block';
                document.getElementById('form-title').textContent = '添加場景切換熱點';
                document.getElementById('hotspot-form').style.display = 'block';
            });
            
            // 保存熱點按鈕事件
            document.getElementById('save-hotspots-btn').addEventListener('click', saveAllHotspots);
            
            // 熱點類型切換事件
            document.getElementById('hotspot-type').addEventListener('change', function() {
                const type = this.value;
                if (type === 'info') {
                    document.getElementById('info-id-group').style.display = 'block';
                    document.getElementById('scene-id-group').style.display = 'none';
                } else {
                    document.getElementById('info-id-group').style.display = 'none';
                    document.getElementById('scene-id-group').style.display = 'block';
                }
            });
            
            // 取消添加熱點按鈕事件
            document.getElementById('cancel-hotspot-btn').addEventListener('click', function() {
                document.getElementById('hotspot-form').style.display = 'none';
                if (tempHotspot) {
                    viewer.removeHotSpot(tempHotspot);
                    tempHotspot = null;
                }
                currentHotspotData = null;
            });
            
            // 確認添加熱點按鈕事件
            document.getElementById('confirm-hotspot-btn').addEventListener('click', addNewHotspot);
            
            // 刪除熱點按鈕事件
            document.getElementById('delete-hotspot-btn').addEventListener('click', deleteSelectedHotspot);
            
            // 為全景圖添加熱點點擊事件（用於編輯模式）
            document.getElementById('panorama').addEventListener('click', handleHotspotClick);
        });
    </script>
</body>
</html>