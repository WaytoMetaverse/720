<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多房間環景導覽平台</title>
    <!-- A-Frame 框架 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <!-- Three.js 用於數學計算 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn.active {
            background-color: #16a085;
        }
        
        .vr-btn {
            background-color: #e74c3c;
        }
        
        .vr-btn:hover {
            background-color: #c0392b;
        }
        
        .property-info {
            position: fixed;
            top: 5rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 4px;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        
        .property-info h2 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .property-info p {
            margin-bottom: 0.5rem;
            color: #34495e;
        }
        
        .room-selector {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0.5rem;
            border-radius: 4px;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        
        .room-btn {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .room-btn:hover, .room-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            z-index: 1000;
            display: none;
        }
        
        .info-popup h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .info-popup p {
            margin-bottom: 1rem;
            color: #34495e;
        }
        
        .info-popup img {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1001;
        }
        
        .loader::after {
            content: "";
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .editor-controls {
            position: fixed;
            top: 5rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }
        
        .hotspot-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 300px;
            z-index: 1000;
            display: none;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        /* 隱藏 A-Frame 默認的 VR 按鈕，使用自定義 UI */
        .a-enter-vr {
            display: none !important;
        }
        
        /* 連接圖顯示樣式 */
        .connection-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .connection-modal h2 {
            color: white;
            margin-bottom: 1.5rem;
        }
        
        .connection-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
        }
        
        .room-card {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .room-card h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }
        
        .room-card h4 {
            margin: 1rem 0 0.5rem;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .room-card ul {
            list-style-type: none;
            padding-left: 0.5rem;
        }
        
        .room-card li {
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        
        .connection-modal .btn {
            margin-top: 1.5rem;
        }
        
        /* 導航輔助 */
        .nav-helper {
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0.8rem;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-width: 200px;
            font-size: 0.9rem;
            transition: opacity 0.3s;
        }
        
        .nav-helper h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .nav-helper p {
            margin-bottom: 0.5rem;
            color: #34495e;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">房地產環景導覽</div>
            <div class="controls">
                <button class="btn" id="map-btn">連接圖</button>
                <button class="btn" id="fullscreen-btn">全螢幕</button>
                <button class="btn vr-btn" id="vr-btn">VR模式</button>
                <button class="btn" id="edit-btn">編輯模式</button>
                <button class="btn" id="exit-edit-btn" style="display: none;">退出編輯</button>
                <button class="btn" id="help-btn">幫助</button>
            </div>
        </header>
        
        <div class="property-info">
            <h2>豪華示範住宅</h2>
            <p><strong>坪數:</strong> 40坪</p>
            <p><strong>格局:</strong> 4房2廳2衛</p>
            <p><strong>樓層:</strong> 1-4F/RF</p>
            <p><strong>地址:</strong> 維次宇宙</p>
            <p id="current-room"></p>
        </div>
        
        <div class="room-selector">
            <button class="room-btn active" data-room="living">客廳</button>
            <button class="room-btn" data-room="kitchen">餐廳</button>
            <button class="room-btn" data-room="master">2F臥室</button>
            <button class="room-btn" data-room="bedroom">3F臥室</button>
            <button class="room-btn" data-room="bathroom">浴室</button>
            <button class="room-btn" data-room="balcony">陽台</button>
        </div>
        
        <div class="info-popup" id="info-popup">
            <button class="close-btn" id="close-popup">&times;</button>
            <h3 id="popup-title"></h3>
            <img id="popup-img" src="" alt="">
            <p id="popup-description"></p>
        </div>
        
        <div class="editor-controls" id="editor-controls">
            <button class="btn" id="add-info-btn">添加資訊熱點</button>
            <button class="btn" id="add-scene-btn">添加場景熱點</button>
            <button class="btn" id="add-center-btn">中央添加熱點</button>
            <button class="btn" id="save-hotspots-btn">保存熱點</button>
            <button class="btn" id="check-connections-btn">檢查連接</button>
            <button class="btn" id="delete-hotspot-btn" style="display: none;">刪除熱點</button>
        </div>
        
        <div class="hotspot-form" id="hotspot-form">
            <h3 id="form-title">添加熱點</h3>
            <div class="form-group">
                <label for="hotspot-type">熱點類型</label>
                <select id="hotspot-type">
                    <option value="info">資訊熱點</option>
                    <option value="scene">場景切換熱點</option>
                </select>
            </div>
            <div class="form-group">
                <label for="hotspot-text">顯示文字</label>
                <input type="text" id="hotspot-text" placeholder="輸入熱點顯示文字">
            </div>
            <div class="form-group" id="info-id-group">
                <label for="hotspot-id">熱點ID</label>
                <input type="text" id="hotspot-id" placeholder="輸入唯一ID">
            </div>
            <div class="form-group" id="info-title-group">
                <label for="info-title">資訊標題</label>
                <input type="text" id="info-title" placeholder="輸入資訊標題">
            </div>
            <div class="form-group" id="info-desc-group">
                <label for="info-desc">資訊描述</label>
                <textarea id="info-desc" placeholder="輸入詳細描述"></textarea>
            </div>
            <div class="form-group" id="scene-id-group" style="display: none;">
                <label for="scene-id">目標場景</label>
                <select id="scene-id">
                    <option value="living">客廳</option>
                    <option value="kitchen">餐廳</option>
                    <option value="master">2F臥室</option>
                    <option value="bedroom">3F臥室</option>
                    <option value="bathroom">浴室</option>
                    <option value="balcony">陽台</option>
                </select>
                <label for="direction-hint" style="margin-top:10px">方向提示</label>
                <input type="text" id="direction-hint" placeholder="例如：上樓、回客廳">
            </div>
            <div class="form-actions">
                <button class="btn" id="cancel-hotspot-btn">取消</button>
                <button class="btn" id="confirm-hotspot-btn">確認</button>
            </div>
        </div>
        
        <div class="nav-helper" id="nav-helper" style="display:none">
            <h4>導航輔助</h4>
            <p id="nav-helper-text"></p>
        </div>
        
        <div class="loader" id="loader"></div>
    </div>
    
    <!-- A-Frame 場景 -->
    <a-scene cursor="rayOrigin: mouse" raycaster="objects: .hotspot, a-sky" vr-mode-ui="enabled: false">
        <a-assets id="assets">
            <img id="panorama" crossorigin="anonymous">
        </a-assets>
        <a-sky id="sky" src="#panorama" rotation="0 0 0"></a-sky>
        <!-- 熱點容器 -->
        <a-entity id="hotspots-container"></a-entity>
        <!-- 相機及游標 -->
        <a-camera id="camera" look-controls position="0 1.6 0">
            <a-cursor raycaster="objects: .hotspot" color="#FFFFFF"></a-cursor>
        </a-camera>
        <!-- VR控制器 -->
        <a-entity laser-controls="hand: right" raycaster="objects: .hotspot;"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: .hotspot;"></a-entity>
    </a-scene>
    
    <script>
        // 房間定義
        const rooms = {
            living: {
                url: "1F客廳.jpg", 
                title: "寬敞客廳",
                displayName: "客廳",
                description: "明亮寬敞的客廳空間，是家人共聚的理想場所。",
                hotSpots: []
            },
            kitchen: {
                url: "1F餐廳.jpg", 
                title: "餐廳",
                displayName: "餐廳",
                description: "舒適的用餐空間，能容納全家人共享美食時光。",
                hotSpots: []
            },
            master: {
                url: "2F臥室.jpg", 
                title: "主臥室",
                displayName: "2F主臥室",
                description: "寬敞舒適的主臥室，擁有充足的自然光線。",
                hotSpots: []
            },
            bedroom: {
                url: "3F臥室1.jpg", 
                title: "次臥",
                displayName: "3F臥室",
                description: "功能齊全的次臥室，適合客人或孩子使用。",
                hotSpots: []
            },
            bathroom: {
                url: "2F浴室.jpg", 
                title: "浴室",
                displayName: "浴室",
                description: "現代化的衛浴空間，提供舒適的沐浴體驗。",
                hotSpots: []
            },
            balcony: {
                url: "RF陽台.jpg", 
                title: "陽台",
                displayName: "頂樓陽台",
                description: "寬敞的頂樓陽台，可眺望周圍美麗景色。",
                hotSpots: []
            }
        };
        
        // 熱點信息存儲
        const hotspotInfo = {};
        
        // 推薦熱點配置
        const recommendedHotspots = {
            living: [
                {type: 'scene', target: 'kitchen', position: '右側/前方', text: '前往餐廳'},
                {type: 'scene', target: 'master', position: '樓梯/後方', text: '上樓到2F'},
                {type: 'info', id: 'living-sofa', text: '客廳沙發', title: '舒適沙發組', description: '高品質義大利進口真皮沙發，舒適耐用，可容納全家人。'}
            ],
            kitchen: [
                {type: 'scene', target: 'living', position: '左側/出口', text: '回到客廳'},
                {type: 'info', id: 'kitchen-table', text: '餐桌', title: '六人餐桌', description: '實木六人餐桌，是家人共享美食時光的理想場所。'}
            ],
            master: [
                {type: 'scene', target: 'living', position: '樓梯/出口', text: '下樓回客廳'},
                {type: 'scene', target: 'bathroom', position: '右側/附近', text: '前往浴室'},
                {type: 'scene', target: 'bedroom', position: '樓梯/走廊', text: '上樓到3F'},
                {type: 'info', id: 'master-bed', text: '主臥床組', title: '雙人床', description: '高品質雙人床組，搭配舒適床墊，確保良好的睡眠品質。'}
            ],
            bedroom: [
                {type: 'scene', target: 'master', position: '樓梯/出口', text: '下樓到2F'},
                {type: 'scene', target: 'balcony', position: '窗戶/陽台門', text: '前往頂樓陽台'},
                {type: 'info', id: 'bedroom-desk', text: '書桌', title: '工作書桌', description: '功能實用的工作書桌，適合在家辦公或學習使用。'}
            ],
            bathroom: [
                {type: 'scene', target: 'master', position: '門口/出口', text: '回到臥室'},
                {type: 'info', id: 'bathroom-shower', text: '淋浴間', title: '淋浴設備', description: '現代化淋浴設備，提供舒適的沐浴體驗。'}
            ],
            balcony: [
                {type: 'scene', target: 'bedroom', position: '門口/入口', text: '回到3F臥室'},
                {type: 'info', id: 'balcony-view', text: '景觀', title: '城市景觀', description: '從頂樓陽台可以欣賞到絕佳的城市景觀。'}
            ]
        };
        
        // 全局變量
        let currentScene = 'living';
        let isEditMode = false;
        let tempHotspotEntity = null;
        let currentHotspotData = null;
        let selectedHotspotId = null;
        
        // 獲取房間顯示名稱
        function getRoomDisplayName(roomId) {
            return rooms[roomId] ? rooms[roomId].displayName : roomId;
        }
        
        // 加載場景
        function loadScene(sceneName) {
            if (!rooms[sceneName]) {
                console.error('場景不存在:', sceneName);
                return;
            }
            
            // 顯示加載圖標
            document.getElementById('loader').style.display = 'flex';
            
            const scene = rooms[sceneName];
            currentScene = sceneName;
            
            // 更新當前房間信息
            document.getElementById('current-room').textContent = '當前位置: ' + scene.displayName;
            
            // 更新全景圖
            const panoramaAsset = document.getElementById('panorama');
            panoramaAsset.src = scene.url + '?t=' + new Date().getTime(); // 添加時間戳防止緩存
            
            // 確保圖片加載後更新天空球
            panoramaAsset.onload = function() {
                const sky = document.getElementById('sky');
                sky.setAttribute('src', '#panorama');
                
                // 隱藏加載圖標
                document.getElementById('loader').style.display = 'none';
                
                // 更新熱點
                updateHotspots();
                
                // 顯示導航輔助
                showNavigationHelper(sceneName);
            };
            
            // 更新房間選擇按鈕狀態
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (btn.dataset.room === sceneName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // 顯示導航輔助
        function showNavigationHelper(sceneName) {
            const navHelper = document.getElementById('nav-helper');
            const navText = document.getElementById('nav-helper-text');
            
            // 找出可用的出口
            const exits = rooms[sceneName].hotSpots.filter(h => h.type === 'scene');
            
            if (exits.length > 0) {
                let text = '可用出口: ';
                exits.forEach((exit, index) => {
                    text += exit.text;
                    if (index < exits.length - 1) text += ', ';
                });
                navText.textContent = text;
                navHelper.style.display = 'block';
                
                // 5秒後自動隱藏
                setTimeout(() => {
                    navHelper.style.opacity = '0';
                    setTimeout(() => {
                        navHelper.style.display = 'none';
                        navHelper.style.opacity = '1';
                    }, 500);
                }, 5000);
            } else {
                navHelper.style.display = 'none';
            }
        }
        
        // 更新場景中的所有熱點
        function updateHotspots() {
            // 清除所有現有熱點
            const hotspotsContainer = document.getElementById('hotspots-container');
            while (hotspotsContainer.firstChild) {
                hotspotsContainer.removeChild(hotspotsContainer.firstChild);
            }
            
            // 添加當前場景的熱點
            const sceneHotspots = rooms[currentScene].hotSpots;
            if (sceneHotspots && sceneHotspots.length > 0) {
                sceneHotspots.forEach(hotspot => {
                    createHotspotEntity(hotspot);
                });
            }
        }
        
        // 創建熱點實體
        function createHotspotEntity(hotspot) {
            // 將球面座標轉換為3D坐標
            const radius = 10;
            const phi = THREE.MathUtils.degToRad(90 - hotspot.pitch); // 垂直角度
            const theta = THREE.MathUtils.degToRad(hotspot.yaw); // 水平角度
            
            // 計算3D位置
            const x = -radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.cos(phi);
            const z = -radius * Math.sin(phi) * Math.sin(theta);
            
            // 創建熱點實體
            const hotspotEntity = document.createElement('a-entity');
            hotspotEntity.classList.add('hotspot');
            hotspotEntity.setAttribute('id', hotspot.id || 'scene-' + hotspot.sceneId);
            hotspotEntity.setAttribute('position', `${x} ${y} ${z}`);
            
            // 根據熱點類型設置顏色
            const color = hotspot.type === 'info' ? '#3498db' : '#e74c3c';
            
            // 創建環形熱點
            hotspotEntity.setAttribute('geometry', 'primitive: ring; radiusInner: 0.2; radiusOuter: 0.3');
            hotspotEntity.setAttribute('material', `color: ${color}; shader: flat; opacity: 0.9; side: double`);
            
            // 添加內部填充
            const innerCircle = document.createElement('a-entity');
            innerCircle.setAttribute('geometry', 'primitive: circle; radius: 0.18');
            innerCircle.setAttribute('material', `color: ${color}; shader: flat; opacity: 0.5; side: double`);
            innerCircle.setAttribute('position', '0 0 -0.01');
            hotspotEntity.appendChild(innerCircle);
            
            // 添加動畫效果
            hotspotEntity.setAttribute('animation__scale', 'property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true');
            hotspotEntity.setAttribute('animation__rotate', 'property: rotation; to: 0 360 0; dur: 15000; easing: linear; loop: true');
            
            // 添加文字標籤
            const textEntity = document.createElement('a-entity');
            textEntity.setAttribute('text', `value: ${hotspot.text}; align: center; width: 5; color: white; side: double`);
            textEntity.setAttribute('position', '0 0.5 0');
            textEntity.setAttribute('geometry', 'primitive: plane; width: auto; height: auto');
            textEntity.setAttribute('material', 'color: #333; opacity: 0.7');
            textEntity.setAttribute('look-at', '[camera]');
            hotspotEntity.appendChild(textEntity);
            
            // 添加點擊事件
            hotspotEntity.addEventListener('click', function(event) {
                if (isEditMode) {
                    // 在編輯模式下，點擊選擇熱點
                    handleHotspotSelection(hotspot.id || 'scene-' + hotspot.sceneId);
                } else {
                    // 顯示點擊反饋
                    this.setAttribute('material', `color: white; shader: flat; opacity: 0.9`);
                    setTimeout(() => {
                        this.setAttribute('material', `color: ${color}; shader: flat; opacity: 0.9`);
                    }, 200);
                    
                    // 正常模式下，處理熱點點擊
                    if (hotspot.type === 'info' && hotspot.id) {
                        showInfoPopup(hotspot.id);
                    } else if (hotspot.type === 'scene' && hotspot.sceneId) {
                        // 場景切換效果
                        const sky = document.getElementById('sky');
                        sky.setAttribute('animation', {
                            property: 'material.opacity',
                            from: 1,
                            to: 0,
                            dur: 300,
                            easing: 'easeOutQuad'
                        });
                        
                        setTimeout(() => {
                            loadScene(hotspot.sceneId);
                            sky.setAttribute('animation', {
                                property: 'material.opacity',
                                from: 0,
                                to: 1,
                                dur: 300,
                                easing: 'easeInQuad'
                            });
                        }, 300);
                    }
                }
            });
            
            // 添加懸停效果
            hotspotEntity.addEventListener('mouseenter', function() {
                this.setAttribute('scale', '1.3 1.3 1.3');
            });
            
            hotspotEntity.addEventListener('mouseleave', function() {
                this.setAttribute('scale', '1 1 1');
            });
            
            // 將熱點添加到容器
            document.getElementById('hotspots-container').appendChild(hotspotEntity);
            
            return hotspotEntity;
        }
        
        // 顯示信息彈窗
        function showInfoPopup(hotspotId) {
            const info = hotspotInfo[hotspotId];
            if (!info) return;
            
            const popup = document.getElementById('info-popup');
            
            document.getElementById('popup-title').textContent = info.title;
            document.getElementById('popup-img').src = info.img;
            document.getElementById('popup-img').alt = info.title;
            document.getElementById('popup-description').textContent = info.description;
            
            popup.style.display = 'block';
        }
        
        // 創建臨時熱點用於編輯
        function createTempHotspot(position) {
            // 如果已存在，先移除
            if (tempHotspotEntity) {
                tempHotspotEntity.parentNode.removeChild(tempHotspotEntity);
            }
            
            // 創建新的臨時熱點
            tempHotspotEntity = document.createElement('a-entity');
            tempHotspotEntity.classList.add('temp-hotspot');
            tempHotspotEntity.setAttribute('position', position.x + ' ' + position.y + ' ' + position.z);
            tempHotspotEntity.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
            tempHotspotEntity.setAttribute('material', 'color: yellow; opacity: 0.7');
            
            // 添加到場景
            document.getElementById('hotspots-container').appendChild(tempHotspotEntity);
            
            return tempHotspotEntity;
        }
        
        // 開啟/關閉編輯模式
        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            const editorControls = document.getElementById('editor-controls');
            const editBtn = document.getElementById('edit-btn');
            const exitEditBtn = document.getElementById('exit-edit-btn');
            
            if (isEditMode) {
                // 開啟編輯模式
                editorControls.style.display = 'flex';
                editBtn.style.display = 'none';
                exitEditBtn.style.display = 'inline-block';
                
                // 禁用房間切換
                document.querySelectorAll('.room-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                // 添加點擊場景事件
                document.querySelector('a-scene').addEventListener('click', handleSceneClick);
            } else {
                // 關閉編輯模式
                editorControls.style.display = 'none';
                editBtn.style.display = 'inline-block';
                exitEditBtn.style.display = 'none';
                document.getElementById('delete-hotspot-btn').style.display = 'none';
                
                // 啟用房間切換
                document.querySelectorAll('.room-btn').forEach(btn => {
                    btn.disabled = false;
                });
                
                // 移除點擊場景事件
                document.querySelector('a-scene').removeEventListener('click', handleSceneClick);
                
                // 移除臨時熱點
                if (tempHotspotEntity) {
                    tempHotspotEntity.parentNode.removeChild(tempHotspotEntity);
                    tempHotspotEntity = null;
                }
            }
        }
        
        // 處理場景點擊（編輯模式下）
        function handleSceneClick(event) {
            // 確保只在編輯模式下有效
            if (!isEditMode) return;
            
            // 忽略熱點點擊
            if (event.detail.intersectedEl && 
                (event.detail.intersectedEl.classList.contains('hotspot') || 
                 event.detail.intersectedEl.parentNode.classList.contains('hotspot'))) {
                return;
            }
            
            // 獲取點擊位置
            if (event.detail.intersection) {
                const point = event.detail.intersection.point;
                
                // 創建臨時熱點
                createTempHotspot(point);
                
                // 計算球面坐標（用於保存）
                const camera = document.getElementById('camera');
                const cameraPos = camera.getAttribute('position');
                
                // 計算相對於原點的方向向量
                const directionX = point.x;
                const directionY = point.y;
                const directionZ = point.z;
                
                // 計算球面坐標
                const radius = Math.sqrt(directionX * directionX + directionY * directionY + directionZ * directionZ);
                const phi = Math.acos(directionY / radius); // 垂直角度 (0 到 π)
                const theta = Math.atan2(directionZ, directionX); // 水平角度 (-π 到 π)
                
                // 轉換為Pannellum格式的角度
                const pitch = 90 - THREE.MathUtils.radToDeg(phi); // -90 到 90
                const yaw = THREE.MathUtils.radToDeg(theta); // -180 到 180
                
                // 儲存當前熱點數據
                currentHotspotData = {
                    position: point,
                    pitch: pitch,
                    yaw: yaw
                };
                
                // 清空表單
                document.getElementById('hotspot-text').value = '';
                document.getElementById('hotspot-id').value = '';
                document.getElementById('info-title').value = '';
                document.getElementById('info-desc').value = '';
                document.getElementById('direction-hint').value = '';
                
                // 顯示熱點表單
                document.getElementById('hotspot-form').style.display = 'block';
            }
        }
        
        // 處理中央添加熱點
        function handleCenterHotspot() {
            // 獲取相機位置和方向
            const camera = document.getElementById('camera');
            const cameraRotation = camera.getAttribute('rotation');
            
            // 計算相機前方的點
            const rad = THREE.MathUtils.degToRad(-cameraRotation.y);
            const x = -10 * Math.sin(rad);
            const y = 10 * Math.tan(THREE.MathUtils.degToRad(cameraRotation.x));
            const z = -10 * Math.cos(rad);
            
            // 創建熱點
            const point = {x: x, y: y, z: z};
            createTempHotspot(point);
            
            // 計算球面坐標
            const radius = Math.sqrt(x*x + y*y + z*z);
            const phi = Math.acos(y / radius);
            const theta = Math.atan2(z, x);
            
            const pitch = 90 - THREE.MathUtils.radToDeg(phi);
            const yaw = THREE.MathUtils.radToDeg(theta);
            
            currentHotspotData = {
                position: point,
                pitch: pitch,
                yaw: yaw
            };
            
            // 基於當前房間推薦熱點
            suggestHotspot();
            
            // 顯示熱點表單
            document.getElementById('hotspot-form').style.display = 'block';
        }
        
        // 推薦熱點設置
        function suggestHotspot() {
            const recommendations = recommendedHotspots[currentScene];
            if (!recommendations || recommendations.length === 0) return;
            
            // 找到尚未實現的推薦熱點
            const existingSceneHotspots = rooms[currentScene].hotSpots
                .filter(h => h.type === 'scene')
                .map(h => h.sceneId);
                
            const existingInfoHotspots = rooms[currentScene].hotSpots
                .filter(h => h.type === 'info')
                .map(h => h.id);
                
            const pendingRecommendations = recommendations.filter(rec => {
                if (rec.type === 'scene') {
                    return !existingSceneHotspots.includes(rec.target);
                } else {
                    return !existingInfoHotspots.includes(rec.id);
                }
            });
            
            if (pendingRecommendations.length === 0) return;
            
            // 使用第一個推薦
            const recommendation = pendingRecommendations[0];
            
            // 填充表單
            document.getElementById('hotspot-type').value = recommendation.type;
            document.getElementById('hotspot-text').value = recommendation.text;
            
            if (recommendation.type === 'info') {
                document.getElementById('info-id-group').style.display = 'block';
                document.getElementById('info-title-group').style.display = 'block';
                document.getElementById('info-desc-group').style.display = 'block';
                document.getElementById('scene-id-group').style.display = 'none';
                
                document.getElementById('hotspot-id').value = recommendation.id;
                document.getElementById('info-title').value = recommendation.title || recommendation.text;
                document.getElementById('info-desc').value = recommendation.description || '';
            } else {
                document.getElementById('info-id-group').style.display = 'none';
                document.getElementById('info-title-group').style.display = 'none';
                document.getElementById('info-desc-group').style.display = 'none';
                document.getElementById('scene-id-group').style.display = 'block';
                
                document.getElementById('scene-id').value = recommendation.target;
                document.getElementById('direction-hint').value = recommendation.text;
            }
        }
        
        // 處理熱點選擇（編輯模式下）
        function handleHotspotSelection(hotspotId) {
            if (!isEditMode) return;
            
            selectedHotspotId = hotspotId;
            
            // 顯示刪除按鈕
            const deleteBtn = document.getElementById('delete-hotspot-btn');
            deleteBtn.style.display = 'block';
            deleteBtn.textContent = `刪除熱點: ${hotspotId}`;
        }
        
        // 添加新熱點
        function addNewHotspot() {
            if (!currentHotspotData) return;
            
            const type = document.getElementById('hotspot-type').value;
            const text = document.getElementById('hotspot-text').value;
            
            if (!text) {
                alert('請輸入熱點顯示文字');
                return;
            }
            
            let newHotspot = {
                pitch: currentHotspotData.pitch,
                yaw: currentHotspotData.yaw,
                type: type,
                text: text
            };
            
            if (type === 'info') {
                const id = document.getElementById('hotspot-id').value;
                if (!id) {
                    alert('請輸入熱點ID');
                    return;
                }
                newHotspot.id = id;
                
                // 檢查ID是否已存在
                const idExists = rooms[currentScene].hotSpots.some(h => h.id === id);
                if (idExists) {
                    alert('此ID已存在，請使用其他ID');
                    return;
                }
                
                // 獲取信息標題和描述
                const infoTitle = document.getElementById('info-title').value || text;
                const infoDesc = document.getElementById('info-desc').value || "尚無詳細描述";
                
                // 添加到hotspotInfo
                hotspotInfo[id] = {
                    title: infoTitle,
                    img: rooms[currentScene].url,
                    description: infoDesc
                };
            } else if (type === 'scene') {
                const sceneId = document.getElementById('scene-id').value;
                newHotspot.sceneId = sceneId;
                
                // 添加方向提示
                const directionHint = document.getElementById('direction-hint').value;
                if (directionHint) {
                    newHotspot.text = directionHint;
                }
            }
            
            // 添加到場景熱點列表
            rooms[currentScene].hotSpots.push(newHotspot);
            
            // 重新加載熱點
            updateHotspots();
            
            // 移除臨時熱點
            if (tempHotspotEntity) {
                tempHotspotEntity.parentNode.removeChild(tempHotspotEntity);
                tempHotspotEntity = null;
            }
            
            // 隱藏表單
            document.getElementById('hotspot-form').style.display = 'none';
            currentHotspotData = null;
        }
        
        // 刪除選定熱點
        function deleteSelectedHotspot() {
            if (!selectedHotspotId) return;
            
            // 從熱點列表中移除
            rooms[currentScene].hotSpots = rooms[currentScene].hotSpots.filter(h => {
                if (h.type === 'info') {
                    return h.id !== selectedHotspotId;
                } else {
                    return 'scene-' + h.sceneId !== selectedHotspotId;
                }
            });
            
            // 更新熱點顯示
            updateHotspots();
            
            // 隱藏刪除按鈕
            document.getElementById('delete-hotspot-btn').style.display = 'none';
            selectedHotspotId = null;
        }
        
        // 檢查連接
        function checkConnections() {
            const missingConnections = [];
            
            // 檢查每個房間的基本連接
            Object.keys(rooms).forEach(roomId => {
                const roomHotspots = rooms[roomId].hotSpots;
                const outgoingConnections = roomHotspots
                    .filter(h => h.type === 'scene')
                    .map(h => h.sceneId);
                
                // 檢查此房間有沒有連出去的路徑
                if (outgoingConnections.length === 0) {
                    missingConnections.push(`${getRoomDisplayName(roomId)} 沒有任何出口`);
                }
                
                // 檢查此房間是否被其他房間連接
                const isConnectedFrom = Object.keys(rooms).some(otherRoomId => {
                    if (otherRoomId === roomId) return false;
                    return rooms[otherRoomId].hotSpots.some(h => 
                        h.type === 'scene' && h.sceneId === roomId
                    );
                });
                
                if (!isConnectedFrom) {
                    missingConnections.push(`沒有任何房間連接到 ${getRoomDisplayName(roomId)}`);
                }
            });
            
            // 顯示結果
            if (missingConnections.length === 0) {
                alert('所有房間連接正常！');
            } else {
                alert('發現連接問題:\n\n' + missingConnections.join('\n'));
            }
        }
        
        // 顯示連接圖
        function showConnectionMap() {
            // 創建連接圖
            const connections = {};
            
            Object.keys(rooms).forEach(roomId => {
                connections[roomId] = {
                    name: getRoomDisplayName(roomId),
                    outgoing: [],
                    incoming: []
                };
                
                // 添加出站連接
                rooms[roomId].hotSpots.forEach(hotspot => {
                    if (hotspot.type === 'scene' && hotspot.sceneId) {
                        connections[roomId].outgoing.push({
                            to: hotspot.sceneId,
                            text: hotspot.text
                        });
                    }
                });
            });
            
            // 填充入站連接
            Object.keys(connections).forEach(roomId => {
                Object.keys(connections).forEach(otherRoomId => {
                    connections[otherRoomId].outgoing.forEach(conn => {
                        if (conn.to === roomId) {
                            connections[roomId].incoming.push({
                                from: otherRoomId,
                                text: conn.text
                            });
                        }
                    });
                });
            });
            
            // 顯示連接圖
            let html = '<h2>房間連接關係</h2><div class="connection-map">';
            
            Object.keys(connections).forEach(roomId => {
                const room = connections[roomId];
                html += `<div class="room-card">
                    <h3>${room.name}</h3>
                    <div class="outgoing">
                        <h4>出站連接:</h4>
                        <ul>
                            ${room.outgoing.map(conn => 
                                `<li>→ ${getRoomDisplayName(conn.to)} (${conn.text})</li>`).join('') || '<li>無</li>'}
                        </ul>
                    </div>
                    <div class="incoming">
                        <h4>入站連接:</h4>
                        <ul>
                            ${room.incoming.map(conn => 
                                `<li>← ${getRoomDisplayName(conn.from)} (${conn.text})</li>`).join('') || '<li>無</li>'}
                        </ul>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            
            // 在模態對話框中顯示
            const modalDiv = document.createElement('div');
            modalDiv.className = 'connection-modal';
            modalDiv.innerHTML = html;
            document.body.appendChild(modalDiv);
            
            // 添加關閉按鈕
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '關閉';
            closeBtn.className = 'btn';
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modalDiv);
            });
            modalDiv.appendChild(closeBtn);
        }
        
        // =========== 熱點數據保存與載入功能 ===========
        
        // 保存所有熱點為 JSON 文件
        function saveAllHotspots() {
            // 收集所有房間的熱點數據
            const allData = {};
            
            Object.keys(rooms).forEach(scene => {
                allData[scene] = {
                    hotSpots: rooms[scene].hotSpots
                };
            });
            
            // 也保存所有的熱點信息
            allData.hotspotInfo = hotspotInfo;
            
            // 轉換為格式化的 JSON 字符串
            const dataStr = JSON.stringify(allData, null, 2);
            
            // 創建一個可下載的 data URI
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            // 創建一個隱藏的下載連結
            const exportLink = document.createElement('a');
            exportLink.setAttribute('href', dataUri);
            exportLink.setAttribute('download', 'panorama-hotspots.json');
            document.body.appendChild(exportLink);
            
            // 自動點擊下載連結
            exportLink.click();
            
            // 清理 DOM
            document.body.removeChild(exportLink);
            
            // 通知用戶
            alert('熱點數據已導出為 JSON 文件。請將此文件上傳到您的網站根目錄，替換現有的 panorama-hotspots.json 文件。');
        }
        
        // 從 JSON 文件加載熱點
        function loadHotspotsFromJSON() {
            // 顯示加載圖標
            document.getElementById('loader').style.display = 'flex';
            
            fetch('panorama-hotspots.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('未找到熱點數據文件');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('成功加載熱點數據');
                    
                    // 更新熱點信息
                    if (data.hotspotInfo) {
                        Object.assign(hotspotInfo, data.hotspotInfo);
                    }
                    
                    // 更新房間熱點數據
                    Object.keys(data).forEach(key => {
                        if (key !== 'hotspotInfo' && rooms[key] && data[key].hotSpots) {
                            rooms[key].hotSpots = data[key].hotSpots;
                        }
                    });
                    
                    // 更新當前場景的熱點顯示
                    updateHotspots();
                    
                    // 隱藏加載圖標
                    document.getElementById('loader').style.display = 'none';
                })
                .catch(error => {
                    console.log('熱點數據載入提示:', error.message);
                    // 隱藏加載圖標
                    document.getElementById('loader').style.display = 'none';
                });
        }
        
        // 進入VR模式
        function enterVRMode() {
            // 使用A-Frame內建的enterVR方法
            const scene = document.querySelector('a-scene');
            if (scene.hasLoaded) {
                scene.enterVR();
            } else {
                scene.addEventListener('loaded', function() {
                    scene.enterVR();
                });
            }
        }
        
        // 進入全螢幕模式
        function enterFullscreen() {
            const scene = document.querySelector('a-scene');
            if (scene.requestFullscreen) {
                scene.requestFullscreen();
            } else if (scene.mozRequestFullScreen) { // Firefox
                scene.mozRequestFullScreen();
            } else if (scene.webkitRequestFullscreen) { // Chrome, Safari
                scene.webkitRequestFullscreen();
            } else if (scene.msRequestFullscreen) { // IE/Edge
                scene.msRequestFullscreen();
            }
        }
        
        // 顯示幫助信息
        function showHelp() {
            const helpContent = `
                <h2>環景導覽平台使用幫助</h2>
                
                <h3>基本導覽</h3>
                <p>- 使用滑鼠拖動或觸控滑動來環顧四周</p>
                <p>- 點擊藍色熱點查看詳細信息</p>
                <p>- 點擊紅色熱點可以切換到其他房間</p>
                <p>- 底部的房間選擇器可以直接跳轉到指定房間</p>
                
                <h3>VR模式</h3>
                <p>- 點擊「VR模式」按鈕進入VR體驗</p>
                <p>- 在VR模式中使用控制器指向熱點並點擊進行互動</p>
                <p>- 也可以在手機上使用簡易VR模式，配合Google Cardboard等設備</p>
                
                <h3>編輯模式（需要密碼）</h3>
                <p>- 在編輯模式下可以添加、刪除熱點</p>
                <p>- 點擊場景中的位置可以放置熱點</p>
                <p>- 也可以使用「中央添加熱點」在視線中心添加熱點</p>
                <p>- 完成編輯後請保存熱點數據</p>
                
                <h3>連接圖</h3>
                <p>- 點擊「連接圖」按鈕可以查看所有房間之間的連接關係</p>
                <p>- 使用連接圖確保導覽路徑完整，沒有死胡同</p>
            `;
            
            // 在模態對話框中顯示
            const modalDiv = document.createElement('div');
            modalDiv.className = 'connection-modal';
            modalDiv.innerHTML = helpContent;
            document.body.appendChild(modalDiv);
            
            // 添加關閉按鈕
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '關閉';
            closeBtn.className = 'btn';
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modalDiv);
            });
            modalDiv.appendChild(closeBtn);
        }
        
        // 在文檔加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 從 JSON 文件加載熱點數據（如果存在）
            loadHotspotsFromJSON();
            
            // 加載初始場景
            loadScene('living');
            
            // 房間切換按鈕事件
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!isEditMode) {
                        loadScene(this.dataset.room);
                    }
                });
            });
            
            // 關閉彈窗按鈕事件
            document.getElementById('close-popup').addEventListener('click', function() {
                document.getElementById('info-popup').style.display = 'none';
            });
            
            // 全螢幕按鈕事件
            document.getElementById('fullscreen-btn').addEventListener('click', enterFullscreen);
            
            // VR按鈕事件
            document.getElementById('vr-btn').addEventListener('click', enterVRMode);
            
            // 連接圖按鈕事件
            document.getElementById('map-btn').addEventListener('click', showConnectionMap);
            
            // 幫助按鈕事件
            document.getElementById('help-btn').addEventListener('click', showHelp);
            
            // 編輯模式按鈕事件 - 添加簡單的密碼保護
            document.getElementById('edit-btn').addEventListener('click', function() {
                const password = prompt('請輸入編輯模式密碼（預設: admin）:');
                
                // 設置一個簡單的密碼
                if (password === 'admin') {
                    toggleEditMode();
                } else {
                    alert('密碼錯誤，無法進入編輯模式');
                }
            });
            
            document.getElementById('exit-edit-btn').addEventListener('click', toggleEditMode);
            
            // 添加資訊熱點按鈕事件
            document.getElementById('add-info-btn').addEventListener('click', function() {
                // 如果沒有臨時熱點，提示用戶先點擊場景
                if (!tempHotspotEntity) {
                    alert('請先在場景中點擊一個位置放置熱點');
                    return;
                }
                
                document.getElementById('hotspot-type').value = 'info';
                document.getElementById('info-id-group').style.display = 'block';
                document.getElementById('info-title-group').style.display = 'block';
                document.getElementById('info-desc-group').style.display = 'block';
                document.getElementById('scene-id-group').style.display = 'none';
                document.getElementById('form-title').textContent = '添加資訊熱點';
                document.getElementById('hotspot-form').style.display = 'block';
            });
            
            // 添加場景熱點按鈕事件
            document.getElementById('add-scene-btn').addEventListener('click', function() {
                // 如果沒有臨時熱點，提示用戶先點擊場景
                if (!tempHotspotEntity) {
                    alert('請先在場景中點擊一個位置放置熱點');
                    return;
                }
                
                document.getElementById('hotspot-type').value = 'scene';
                document.getElementById('info-id-group').style.display = 'none';
                document.getElementById('info-title-group').style.display = 'none';
                document.getElementById('info-desc-group').style.display = 'none';
                document.getElementById('scene-id-group').style.display = 'block';
                document.getElementById('form-title').textContent = '添加場景切換熱點';
                document.getElementById('hotspot-form').style.display = 'block';
            });
            
            // 中央添加熱點按鈕事件
            document.getElementById('add-center-btn').addEventListener('click', handleCenterHotspot);
            
            // 保存熱點按鈕事件
            document.getElementById('save-hotspots-btn').addEventListener('click', saveAllHotspots);
            
            // 檢查連接按鈕事件
            document.getElementById('check-connections-btn').addEventListener('click', checkConnections);
            
            // 熱點類型切換事件
            document.getElementById('hotspot-type').addEventListener('change', function() {
                const type = this.value;
                if (type === 'info') {
                    document.getElementById('info-id-group').style.display = 'block';
                    document.getElementById('info-title-group').style.display = 'block';
                    document.getElementById('info-desc-group').style.display = 'block';
                    document.getElementById('scene-id-group').style.display = 'none';
                } else {
                    document.getElementById('info-id-group').style.display = 'none';
                    document.getElementById('info-title-group').style.display = 'none';
                    document.getElementById('info-desc-group').style.display = 'none';
                    document.getElementById('scene-id-group').style.display = 'block';
                }
            });
            
            // 取消添加熱點按鈕事件
            document.getElementById('cancel-hotspot-btn').addEventListener('click', function() {
                document.getElementById('hotspot-form').style.display = 'none';
                if (tempHotspotEntity) {
                    tempHotspotEntity.parentNode.removeChild(tempHotspotEntity);
                    tempHotspotEntity = null;
                }
                currentHotspotData = null;
            });
            
            // 確認添加熱點按鈕事件
            document.getElementById('confirm-hotspot-btn').addEventListener('click', addNewHotspot);
            
            // 刪除熱點按鈕事件
            document.getElementById('delete-hotspot-btn').addEventListener('click', deleteSelectedHotspot);
            
            // 添加全局鍵盤快捷鍵
            document.addEventListener('keydown', function(event) {
                // 只在編輯模式下有效
                if (!isEditMode) return;
                
                // Space鍵：在視線中心添加熱點
                if (event.code === 'Space') {
                    handleCenterHotspot();
                }
                
                // Escape鍵：關閉表單
                if (event.code === 'Escape') {
                    if (document.getElementById('hotspot-form').style.display === 'block') {
                        document.getElementById('cancel-hotspot-btn').click();
                    }
                }
            });
            
            // 檢測WebXR支援
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-vr')
                    .then(function(supported) {
                        if (!supported) {
                            document.getElementById('vr-btn').textContent = 'VR模式 (受限)';
                            document.getElementById('vr-btn').title = '您的設備不支援完全沉浸式VR，但仍可使用簡易VR模式';
                        }
                    });
            } else {
                document.getElementById('vr-btn').textContent = 'VR模式 (受限)';
                document.getElementById('vr-btn').title = '您的瀏覽器不支援WebXR，但仍可使用簡易VR模式';
            }
        });
    </script>
</body>
</html>